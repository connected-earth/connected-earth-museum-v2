import*as THREE from"three";import{GLTFLoader}from"three/addons/loaders/GLTFLoader.js";import{EXRLoader}from"three/addons/loaders/EXRLoader.js";import{DRACOLoader}from"three/addons/loaders/DRACOLoader.js";import{EffectComposer}from"https://cdn.jsdelivr.net/npm/three@0.150.1/examples/jsm/postprocessing/EffectComposer.js";import{RenderPass}from"https://cdn.jsdelivr.net/npm/three@0.150.1/examples/jsm/postprocessing/RenderPass.js";import{OutlinePass}from"https://cdn.jsdelivr.net/npm/three@0.150.1/examples/jsm/postprocessing/OutlinePass.js";import{UnrealBloomPass}from"https://cdn.jsdelivr.net/npm/three@0.150.1/examples/jsm/postprocessing/UnrealBloomPass.js";import{ShaderPass}from"https://cdn.jsdelivr.net/npm/three@0.150.1/examples/jsm/postprocessing/ShaderPass.js";import{RGBShiftShader}from"https://cdn.jsdelivr.net/npm/three@0.150.1/examples/jsm/shaders/RGBShiftShader.js";import{FilmShader}from"https://cdn.jsdelivr.net/npm/three@0.150.1/examples/jsm/shaders/FilmShader.js";import{bgShaderMaterial}from"./scripts/background.js";import{CameraControls}from"./scripts/camera.js";import{loadPointsFromJson,loadPaintingsInfo,loadDict}from"./scripts/json_loader.js";const TOLERANCE=.001,CAMERA_FOV=75,CAMERA_NEAR=.1,CAMERA_FAR=100,CAMERA_FOCUS_DISTANCE=10,PATH_ACCELERATION=.025,PATH_FRICTION=.065,PATH_TERMINAL_VELOCITY=.1,SCROLL_MULTIPLIER=.5,FILM_SHADER_N_INTENSITY=.06,FILM_SHADER_S_INTENSITY=.03,FILM_SHADER_S_COUNT=4096,FILM_SHADER_GRAYSCALE=0,CHROMA_SHADER_AMOUNT=8e-5,OUTLINE_EDGE_STRENGTH=25,OUTLINE_EDGE_GLOW=2,OUTLINE_EDGE_THICKNESS=8,OUTLINE_PULSE_PERIOD=.5,OUTLINE_VISIBLE_EDGE_COLOR="#fe5000",OUTLINE_VISIBLE_EDGE_COLOR_2="#7a17ef",OUTLINE_HIDDEN_EDGE_COLOR="#190aff",BLOOM_INTENSITY=1.3,BLOOM_THRESHOLD=.25,BLOOM_RADIUS=.86,GSAP_DURATION=2,PAINTING_FOCUS_DISTANCE=10,PAINTING_HOVER_DISTANCE=40,PAINTING_NORMAL_OFFSET=5,TOUR_STOPS_DEFAULT=[.001,.0936,.147,.2777,.3355,.4434,.6308,.6563],clamp=(e,n,t)=>Math.min(Math.max(e,n),t),wrap=(e,n,t)=>n+((e-n)%(t-n)+(t-n))%(t-n),sign=e=>(e>0)-(e<0);function isClose(e,n,t=.001){return Math.abs(e-n)<t}function playAudio(e,n){currentAudio&&(currentAudio.pause(),currentAudio.currentTime=0);const t=new Audio(e);currentAudio=t;const o=document.getElementById("legend");o.textContent=n,o.style.animation="none",o.offsetWidth,o.style.animation="fadeIn 0.5s ease-in-out forwards",t.play(),t.onended=()=>{o.style.animation="fadeOut 0.5s ease-in-out forwards",currentAudio=null}}let clock,scene,camera,renderer,composer,controls,paintings,walls,furniture,outlinePass,currentAudio,progression=parseInt(localStorage.getItem("progression"))||0,billy_audios_legends=null;const mouse=new THREE.Vector2,loadingScreen=document.getElementById("loading-screen");let bgMesh,bgRenderTarget,bgCamera,bgScene,savedCameraYaw=parseFloat(localStorage.getItem("cameraYaw"))||0,bgShaderMat=bgShaderMaterial,paintings_info=null,tour_path=null,tour_stops=TOUR_STOPS_DEFAULT.slice(),auto_tour_start=null,tour_target=0,moving_to_painting=!1,looking_at_painting=!1,moveToNext=!1,moveToPrev=!1,path_pos=JSON.parse(localStorage.getItem("pathPos"))||0,path_vel=0;function getNextTarget(e,n){for(let t=0;t<n.length;t++)if(isClose(e,n[t]))return n[(t+1)%n.length];for(let t=0;t<n.length;t++)if(n[t]>e+.001)return n[t];return n[0]}function getPrevTarget(e,n){for(let t=0;t<n.length;t++)if(isClose(e,n[t]))return n[(t-1+n.length)%n.length];for(let t=n.length-1;t>=0;t--)if(n[t]<e-.001)return n[t];return n[n.length-1]}function getClosestStop(e,n){let t,o=1/0;for(let s=0;s<n.length;s++){const i=e.distanceTo(tour_path.getPoint(n[s]));i<o&&(o=i,t=n[s])}return t}function initRenderer(){renderer=new THREE.WebGLRenderer({canvas:document.getElementById("three-canvas"),antialias:!0,stencil:!0,depth:!0}),renderer.setSize(window.innerWidth,window.innerHeight),renderer.toneMapping=THREE.ACESFilmicToneMapping,renderer.toneMappingExposure=1.2,renderer.outputColorSpace=THREE.SRGBColorSpace,renderer.autoClear=!1}function initSceneAndCamera(){scene=new THREE.Scene,camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,100),scene.add(camera)}function initLights(){scene.add(new THREE.AmbientLight(15790320,1))}function loadEnvironment(){(new EXRLoader).load("/assets/exr/rogland_clear_night_2k.exr",(e=>{e.mapping=THREE.EquirectangularReflectionMapping,scene.environment=e}))}function loadMuseumModel(){const e=new GLTFLoader,n=new DRACOLoader;n.setDecoderPath("https://www.gstatic.com/draco/v1/decoders/"),e.setDRACOLoader(n),e.load("/assets/museum/Paintings.glb",(e=>{paintings=e.scene,scene.add(paintings),loadingScreen.classList.add("hide"),0===progression&&(loadingScreen.addEventListener("transitionend",(function e(){loadingScreen.style.display="none",playAudio("/assets/billy_audios/welcome.mp3",billy_audios_legends.welcome),loadingScreen.removeEventListener("transitionend",e)})),progression+=1)})),e.load("/assets/museum/Museum_Floor.glb",(e=>{scene.add(e.scene)})),e.load("/assets/museum/Museum_Furniture.glb",(e=>{furniture=e.scene,scene.add(e.scene)})),e.load("/assets/museum/Museum_Walls.glb",(e=>{walls=e.scene,scene.add(e.scene)})),e.load("/assets/museum/Museum_Signs.glb",(e=>{scene.add(e.scene)})),e.load("/assets/museum/Museum_Emissive.glb",(e=>{console.log(e.scene),e.scene.traverse((e=>{e.isMesh&&(e.material.emissive=new THREE.Color(16777215),e.material.emissiveIntensity=.845,console.log(e.material))})),scene.add(e.scene)}))}function initControls(){controls=new CameraControls(camera,renderer)}function initBackgroundShader(){bgScene=new THREE.Scene,bgCamera=new THREE.OrthographicCamera(-1,1,1,-1,0,1);const e=new THREE.PlaneGeometry(2,2);bgMesh=new THREE.Mesh(e,bgShaderMat),bgMesh.frustumCulled=!1,bgScene.add(bgMesh)}function initPostProcessing(){const e=new ShaderPass(FilmShader);e.uniforms.nIntensity.value=.06,e.uniforms.sIntensity.value=.03,e.uniforms.sCount.value=4096,e.uniforms.grayscale.value=0,composer.addPass(e);const n=new ShaderPass(RGBShiftShader);n.uniforms.amount.value=8e-5,composer.addPass(n),outlinePass=new OutlinePass(new THREE.Vector2(window.innerWidth,window.innerHeight),scene,camera),outlinePass.edgeStrength=25,outlinePass.edgeGlow=2,outlinePass.edgeThickness=8,outlinePass.pulsePeriod=.5,outlinePass.visibleEdgeColor.set("#fe5000"),outlinePass.hiddenEdgeColor.set("#190aff"),composer.addPass(outlinePass),void 0!==outlinePass.clear&&(outlinePass.clear=!1),outlinePass.renderToScreen=!1,composer.addPass(outlinePass),composer.addPass(new UnrealBloomPass(new THREE.Vector2(window.innerWidth,window.innerHeight),1.3,.25,.86))}async function initBilly(){billy_audios_legends=await loadDict("/assets/billy_audios/legends.json")}async function initTour(){paintings_info=await loadPaintingsInfo("/assets/museum/paintings.json");const e=await loadPointsFromJson("/assets/museum/tour.json");tour_path=new THREE.CatmullRomCurve3(e)}function initMuseum(){clock=new THREE.Clock,initBilly(),initRenderer(),initSceneAndCamera(),initLights(),loadEnvironment(),loadMuseumModel(),initControls(),initBackgroundShader(),composer=new EffectComposer(renderer);const e=new RenderPass(bgScene,camera);composer.addPass(e);const n=new RenderPass(scene,camera);n.clear=!1,composer.addPass(n),initPostProcessing(),initTour(),window.addEventListener("resize",onWindowResize),window.addEventListener("mousemove",onMouseMove),window.addEventListener("click",onMouseClick,!1),animate()}function onWindowResize(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight),composer.setSize(window.innerWidth,window.innerHeight)}function lookAtPainting(){const e=document.querySelectorAll("#button-container button"),n=document.getElementById("left-button"),t=document.getElementById("right-button");outlinePass.visibleEdgeColor.set("#7a17ef"),n.style.display="none",t.style.display="none",e[0].style.display="none",e[1].style.display="inline-block"}function backToTour(){const e=document.querySelectorAll("#button-container button"),n=document.getElementById("left-button"),t=document.getElementById("right-button"),o=tour_path.getPoint(path_pos);gsap.to(camera.position,{x:o.x,y:o.y,z:o.z,duration:2,ease:"power3.inOut",onComplete:()=>{controls.dragEnabled=!0,looking_at_painting=!1,n.style.display="inline-block",t.style.display="inline-block",e[0].style.display="inline-block",e[1].style.display="none",outlinePass.visibleEdgeColor.set("#fe5000")}})}function checkMouseOverPainting(e){const n=new THREE.Raycaster;n.setFromCamera(e,camera);const t=[paintings,walls,furniture];try{const e=n.intersectObjects(t);if(e.length>0){const n=e[0].object,t=paintings_info.find((e=>e.name===n.name));if(t)return[!0,e[0],t]}}catch{}return[!1,null]}function onMouseMove(e){mouse.x=e.clientX/window.innerWidth*2-1,mouse.y=-e.clientY/window.innerHeight*2+1,outlinePass.selectedObjects=[];const[n,t,o]=checkMouseOverPainting(mouse);if(n){const e=camera.position.distanceTo(t.point);if(moveToPrev||moveToNext)return;if(e>=40)return;outlinePass.selectedObjects=[t.object]}}function onMouseClick(e){mouse.x=e.clientX/window.innerWidth*2-1,mouse.y=-e.clientY/window.innerHeight*2+1;const[n,t,o]=checkMouseOverPainting(mouse);if(n){if(camera.position.distanceTo(t.point)>=40)return;if(moveToPrev||moveToNext)return;const e=t.face,n=t.object.geometry.attributes.position,s=(new THREE.Vector3).fromBufferAttribute(n,e.a),i=(new THREE.Vector3).fromBufferAttribute(n,e.b),a=(new THREE.Vector3).fromBufferAttribute(n,e.c),r=(new THREE.Vector3).subVectors(i,s),l=(new THREE.Vector3).subVectors(a,s);if(.5*(new THREE.Vector3).crossVectors(r,l).length()<100)return;const c=t.object;c.geometry.boundingBox||c.geometry.computeBoundingBox();const d=c.localToWorld(c.geometry.boundingBox.getCenter(new THREE.Vector3));let m=t.face.normal.clone().applyMatrix3((new THREE.Matrix3).getNormalMatrix(t.object.matrixWorld)).normalize();const u=d.clone().add(m.multiplyScalar(o.distance)),p=d;if(looking_at_painting)return void gsap.to(camera.position,{x:p.x,y:p.y,z:p.z,duration:2,ease:"power3.inOut",onComplete:()=>{window.location.href=o.path}});const g=getClosestStop(u,tour_stops);moving_to_painting=!0,controls.isDragging=!1,controls.dragEnabled=!1;const E=camera.position.clone().add(camera.getWorldDirection(new THREE.Vector3).multiplyScalar(10)),h={posX:camera.position.x,posY:camera.position.y,posZ:camera.position.z,focusX:E.x,focusY:E.y,focusZ:E.z};gsap.to(h,{posX:u.x,posY:u.y,posZ:u.z,focusX:p.x,focusY:p.y,focusZ:p.z,duration:2,ease:"power3.inOut",onUpdate:()=>{camera.position.set(h.posX,h.posY,h.posZ),camera.lookAt(h.focusX,h.focusY,h.focusZ)},onComplete:()=>{controls.dragEnabled=!0,moving_to_painting=!1,looking_at_painting=!0,path_pos=g,controls.yaw=camera.rotation.y,controls.pitch=camera.rotation.x,lookAtPainting(),playAudio(o.audioUrl,billy_audios_legends[o.audioID])}})}}function handleScroll(e){moveToPrev||moveToNext||moving_to_painting||looking_at_painting||(path_vel-=.5*sign(e.deltaY)*.025)}function animate(){const e=clock.getDelta();requestAnimationFrame(animate);const n=clock.getElapsedTime();bgShaderMat.uniforms.uTime.value=n,bgShaderMat.uniforms.uResolution.value.set(window.innerWidth,window.innerHeight);const t=(new THREE.Matrix3).setFromMatrix4((new THREE.Matrix4).makeRotationFromQuaternion(camera.quaternion));if(t.invert(),bgShaderMat.uniforms.uCameraRotation.value.set(t.elements[0],t.elements[1],t.elements[2],t.elements[3],t.elements[4],t.elements[5],t.elements[6],t.elements[7],t.elements[8]),!moving_to_painting&&!looking_at_painting){moveToNext&&(path_vel=.05),moveToPrev&&(path_vel=-.05),path_pos+=path_vel*e,path_vel*=.935,path_vel=clamp(path_vel,-.1,.1),path_pos=wrap(path_pos,0,1),(moveToPrev||moveToNext)&&Math.abs(path_pos-tour_target)<.001&&(moveToNext=!1,moveToPrev=!1,path_vel=0);const n=tour_path.getPoint(path_pos);camera.position.set(n.x,n.y,n.z)}composer.render()}function cleanUpMuseumScene(){const e=(new THREE.Euler).setFromQuaternion(camera.quaternion,"YXZ");localStorage.setItem("cameraYaw",e.y),localStorage.setItem("pathPos",JSON.stringify(path_pos)),localStorage.setItem("progression",progression),paintings&&(scene.remove(paintings),paintings.traverse((e=>{e.isMesh&&(e.geometry.dispose(),e.material.map&&e.material.map.dispose(),e.material.dispose())}))),renderer&&renderer.dispose()}document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("left-button"),n=document.getElementById("right-button"),t=document.getElementById("tour-button");n.addEventListener("click",(function(){moving_to_painting||(moveToPrev=!1,moveToNext=!0,tour_target=getNextTarget(path_pos,tour_stops))})),e.addEventListener("click",(function(){moving_to_painting||(moveToNext=!1,moveToPrev=!0,tour_target=getPrevTarget(path_pos,tour_stops))})),t.addEventListener("click",backToTour),auto_tour_start=path_pos})),window.onload=initMuseum,window.addEventListener("beforeunload",cleanUpMuseumScene),window.addEventListener("wheel",handleScroll),window.addEventListener("pageshow",(e=>{e.persisted&&(window.location.href="museum.html")}));