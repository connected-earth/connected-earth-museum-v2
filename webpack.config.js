const path=require("path"),glob=require("fast-glob"),HtmlWebpackPlugin=require("html-webpack-plugin"),{CleanWebpackPlugin}=require("clean-webpack-plugin"),CopyWebpackPlugin=require("copy-webpack-plugin");function transform_json_paths(e,r){try{const t=JSON.parse(e.toString()),s=e=>{e.forEach((e=>{Object.keys(e).forEach((t=>{"string"==typeof e[t]&&(e[t].startsWith("/")||e[t].startsWith("./")||e[t].startsWith("../"))&&(e[t]=r+e[t].replace(/^\//,""))}))}))};return s(t),JSON.stringify(t,null,2)}catch(r){return console.error(`Error processing JSON file ${file}:`,r),e}}module.exports=(e={})=>{const r="production"===e.NODE_ENV,t=e.PUBLIC_URL||"/";console.log("publicPath",t);const s=t.endsWith("/")?t:`${t}/`,n=["assets/**/*","node_modules"],a=glob.sync("**/*.html",{cwd:path.resolve(__dirname),ignore:n}),o=glob.sync("**/*.css",{cwd:path.resolve(__dirname),ignore:n}),i=glob.sync("**/*.js",{cwd:path.resolve(__dirname),ignore:n});return{mode:r?"production":"development",output:{path:path.resolve(__dirname,"dist"),publicPath:s,clean:!0},entry:"./index.js",plugins:[new CleanWebpackPlugin,new CopyWebpackPlugin({patterns:[{from:path.resolve(__dirname,"assets"),to:path.resolve(__dirname,"dist/assets"),noErrorOnMissing:!0},...o.map((e=>({from:path.resolve(__dirname,e),to:path.resolve(__dirname,"dist",e),noErrorOnMissing:!0}))),...i.map((e=>({from:path.resolve(__dirname,e),to:path.resolve(__dirname,"dist",e),noErrorOnMissing:!0}))),{from:path.resolve(__dirname,"assets","museum","paintings.json"),to:path.resolve(__dirname,"dist","assets","museum","paintings.json"),noErrorOnMissing:!0,transform:e=>transform_json_paths(e,s)}]}),...a.map((e=>new HtmlWebpackPlugin({template:path.resolve(__dirname,e),filename:e,inject:"body",templateParameters:{PUBLIC_URL:t.replace(/\/$/,"")}})))],devServer:{static:path.join(__dirname,"dist"),compress:!0,port:9e3,historyApiFallback:{rewrites:a.map((e=>({from:new RegExp(`^/${e}$`),to:`/${e}`})))}}}};